var background=function(){"use strict";var I,U;function D(t){return t==null||typeof t=="function"?{main:t}:t}function b(t){t?(chrome.action.setBadgeText({text:""}),chrome.action.setBadgeBackgroundColor({color:"rgb(22, 104, 220)"})):(chrome.action.setBadgeText({text:"OFF"}),chrome.action.setBadgeBackgroundColor({color:"rgba(255, 255, 255, 0.25)"}))}var x=(t=>(t.Redirect="redirect",t.SourceMap="sourceMap",t))(x||{});function H(t){const i=[];if(Array.isArray(t)){for(const u of t)if(u.enabled)for(const f of u.rules)f.enabled&&f.source&&(f.target||f.sourceMapUrl)&&i.push(f)}return i}let E=null;function j(){E&&clearTimeout(E),E=setTimeout(()=>{Promise.all([chrome.storage.local.get("enabled"),chrome.declarativeNetRequest.getDynamicRules()]).then(([{enabled:t},i])=>{t?(chrome.action.setBadgeText({text:i.length.toString()}),chrome.action.setBadgeBackgroundColor({color:"rgb(22, 104, 220)"})):b(!1)})},1e3)}async function M(t){const i=H(t);console.log("Enabled input rules",i);const f=(await chrome.declarativeNetRequest.getDynamicRules()).map(g=>g.id),T=i.map((g,S)=>{const{type:v,source:r,sourceType:o}=g;if(v===x.SourceMap){const{sourceMapUrl:c}=g;return{id:S+1,priority:1,action:{type:chrome.declarativeNetRequest.RuleActionType.MODIFY_HEADERS,responseHeaders:[{header:"SourceMap",operation:chrome.declarativeNetRequest.HeaderOperation.SET,value:c}]},condition:{[o||"urlFilter"]:r,resourceTypes:[chrome.declarativeNetRequest.ResourceType.MAIN_FRAME,chrome.declarativeNetRequest.ResourceType.SUB_FRAME,chrome.declarativeNetRequest.ResourceType.STYLESHEET,chrome.declarativeNetRequest.ResourceType.SCRIPT,chrome.declarativeNetRequest.ResourceType.XMLHTTPREQUEST]}}}const{target:l,targetType:n}=g;return{id:S+1,priority:1,action:{type:chrome.declarativeNetRequest.RuleActionType.REDIRECT,redirect:{[n||"url"]:l}},condition:{[o||"urlFilter"]:r,resourceTypes:[chrome.declarativeNetRequest.ResourceType.MAIN_FRAME,chrome.declarativeNetRequest.ResourceType.SUB_FRAME,chrome.declarativeNetRequest.ResourceType.STYLESHEET,chrome.declarativeNetRequest.ResourceType.SCRIPT,chrome.declarativeNetRequest.ResourceType.IMAGE,chrome.declarativeNetRequest.ResourceType.FONT,chrome.declarativeNetRequest.ResourceType.XMLHTTPREQUEST,chrome.declarativeNetRequest.ResourceType.CSP_REPORT,chrome.declarativeNetRequest.ResourceType.MEDIA]}}}).filter(Boolean);console.info("Net request rules:",T);try{chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:f,addRules:T})}catch(g){console.error("Failed to add dynamic rules:",g)}j()}function q(){return chrome.storage.local.get(["enabled","groups"]).then(({enabled:t,groups:i})=>{const u=t===void 0?!1:t;return b(u),u&&M(i||[]),{isEnabled:u,groups:i||[]}})}var N={exports:{}};(function(t){var i=function(){var u=String.fromCharCode,f="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",T="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",g={};function S(r,o){if(!g[r]){g[r]={};for(var l=0;l<r.length;l++)g[r][r.charAt(l)]=l}return g[r][o]}var v={compressToBase64:function(r){if(r==null)return"";var o=v._compress(r,6,function(l){return f.charAt(l)});switch(o.length%4){default:case 0:return o;case 1:return o+"===";case 2:return o+"==";case 3:return o+"="}},decompressFromBase64:function(r){return r==null?"":r==""?null:v._decompress(r.length,32,function(o){return S(f,r.charAt(o))})},compressToUTF16:function(r){return r==null?"":v._compress(r,15,function(o){return u(o+32)})+" "},decompressFromUTF16:function(r){return r==null?"":r==""?null:v._decompress(r.length,16384,function(o){return r.charCodeAt(o)-32})},compressToUint8Array:function(r){for(var o=v.compress(r),l=new Uint8Array(o.length*2),n=0,c=o.length;n<c;n++){var y=o.charCodeAt(n);l[n*2]=y>>>8,l[n*2+1]=y%256}return l},decompressFromUint8Array:function(r){if(r==null)return v.decompress(r);for(var o=new Array(r.length/2),l=0,n=o.length;l<n;l++)o[l]=r[l*2]*256+r[l*2+1];var c=[];return o.forEach(function(y){c.push(u(y))}),v.decompress(c.join(""))},compressToEncodedURIComponent:function(r){return r==null?"":v._compress(r,6,function(o){return T.charAt(o)})},decompressFromEncodedURIComponent:function(r){return r==null?"":r==""?null:(r=r.replace(/ /g,"+"),v._decompress(r.length,32,function(o){return S(T,r.charAt(o))}))},compress:function(r){return v._compress(r,16,function(o){return u(o)})},_compress:function(r,o,l){if(r==null)return"";var n,c,y={},k={},w="",A="",h="",R=2,m=3,p=2,d=[],e=0,a=0,s;for(s=0;s<r.length;s+=1)if(w=r.charAt(s),Object.prototype.hasOwnProperty.call(y,w)||(y[w]=m++,k[w]=!0),A=h+w,Object.prototype.hasOwnProperty.call(y,A))h=A;else{if(Object.prototype.hasOwnProperty.call(k,h)){if(h.charCodeAt(0)<256){for(n=0;n<p;n++)e=e<<1,a==o-1?(a=0,d.push(l(e)),e=0):a++;for(c=h.charCodeAt(0),n=0;n<8;n++)e=e<<1|c&1,a==o-1?(a=0,d.push(l(e)),e=0):a++,c=c>>1}else{for(c=1,n=0;n<p;n++)e=e<<1|c,a==o-1?(a=0,d.push(l(e)),e=0):a++,c=0;for(c=h.charCodeAt(0),n=0;n<16;n++)e=e<<1|c&1,a==o-1?(a=0,d.push(l(e)),e=0):a++,c=c>>1}R--,R==0&&(R=Math.pow(2,p),p++),delete k[h]}else for(c=y[h],n=0;n<p;n++)e=e<<1|c&1,a==o-1?(a=0,d.push(l(e)),e=0):a++,c=c>>1;R--,R==0&&(R=Math.pow(2,p),p++),y[A]=m++,h=String(w)}if(h!==""){if(Object.prototype.hasOwnProperty.call(k,h)){if(h.charCodeAt(0)<256){for(n=0;n<p;n++)e=e<<1,a==o-1?(a=0,d.push(l(e)),e=0):a++;for(c=h.charCodeAt(0),n=0;n<8;n++)e=e<<1|c&1,a==o-1?(a=0,d.push(l(e)),e=0):a++,c=c>>1}else{for(c=1,n=0;n<p;n++)e=e<<1|c,a==o-1?(a=0,d.push(l(e)),e=0):a++,c=0;for(c=h.charCodeAt(0),n=0;n<16;n++)e=e<<1|c&1,a==o-1?(a=0,d.push(l(e)),e=0):a++,c=c>>1}R--,R==0&&(R=Math.pow(2,p),p++),delete k[h]}else for(c=y[h],n=0;n<p;n++)e=e<<1|c&1,a==o-1?(a=0,d.push(l(e)),e=0):a++,c=c>>1;R--,R==0&&(R=Math.pow(2,p),p++)}for(c=2,n=0;n<p;n++)e=e<<1|c&1,a==o-1?(a=0,d.push(l(e)),e=0):a++,c=c>>1;for(;;)if(e=e<<1,a==o-1){d.push(l(e));break}else a++;return d.join("")},decompress:function(r){return r==null?"":r==""?null:v._decompress(r.length,32768,function(o){return r.charCodeAt(o)})},_decompress:function(r,o,l){var n=[],c=4,y=4,k=3,w="",A=[],h,R,m,p,d,e,a,s={val:l(0),position:o,index:1};for(h=0;h<3;h+=1)n[h]=h;for(m=0,d=Math.pow(2,2),e=1;e!=d;)p=s.val&s.position,s.position>>=1,s.position==0&&(s.position=o,s.val=l(s.index++)),m|=(p>0?1:0)*e,e<<=1;switch(m){case 0:for(m=0,d=Math.pow(2,8),e=1;e!=d;)p=s.val&s.position,s.position>>=1,s.position==0&&(s.position=o,s.val=l(s.index++)),m|=(p>0?1:0)*e,e<<=1;a=u(m);break;case 1:for(m=0,d=Math.pow(2,16),e=1;e!=d;)p=s.val&s.position,s.position>>=1,s.position==0&&(s.position=o,s.val=l(s.index++)),m|=(p>0?1:0)*e,e<<=1;a=u(m);break;case 2:return""}for(n[3]=a,R=a,A.push(a);;){if(s.index>r)return"";for(m=0,d=Math.pow(2,k),e=1;e!=d;)p=s.val&s.position,s.position>>=1,s.position==0&&(s.position=o,s.val=l(s.index++)),m|=(p>0?1:0)*e,e<<=1;switch(a=m){case 0:for(m=0,d=Math.pow(2,8),e=1;e!=d;)p=s.val&s.position,s.position>>=1,s.position==0&&(s.position=o,s.val=l(s.index++)),m|=(p>0?1:0)*e,e<<=1;n[y++]=u(m),a=y-1,c--;break;case 1:for(m=0,d=Math.pow(2,16),e=1;e!=d;)p=s.val&s.position,s.position>>=1,s.position==0&&(s.position=o,s.val=l(s.index++)),m|=(p>0?1:0)*e,e<<=1;n[y++]=u(m),a=y-1,c--;break;case 2:return A.join("")}if(c==0&&(c=Math.pow(2,k),k++),n[a])w=n[a];else if(a===y)w=R+R.charAt(0);else return null;A.push(w),n[y++]=R+w.charAt(0),c--,R=w,c==0&&(c=Math.pow(2,k),k++)}}};return v}();t!=null?t.exports=i:typeof angular<"u"&&angular!=null&&angular.module("LZString",[]).factory("LZString",function(){return i})})(N);var L=N.exports;function F(t,i=!1){return t.map(u=>{const f={...u};return i&&Array.isArray(f.rules)&&(f.rules=f.rules.map(T=>{const g={...T};return delete g.enabled,g})),delete f.enabled,f})}function $(t){return t.reduce((i,u)=>{var f;return i+(((f=u.rules)==null?void 0:f.length)||0)},0)}function C(){const t=new Date;return`${t.toLocaleDateString()} ${t.toLocaleTimeString()}`}const G=3,z=.8*102400;function O(t=!1){chrome.alarms.clear("backup");const i=()=>{chrome.storage.local.get(["enableBackup","groups"]).then(({enableBackup:u,groups:f})=>{if(!u)return;const T=F(f,!0);J(T)})};t?i():(chrome.alarms.create("backup",{delayInMinutes:G}),chrome.alarms.onAlarm.addListener(u=>{u.name==="backup"&&i()}))}function Z(){return`backup_${C()}`}async function J(t){await Q();try{const{backupItems:i}=await chrome.storage.sync.get("backupItems"),u=JSON.stringify(t);if(i!=null&&i.length){const g=i[i.length-1],S=await Y(g.key);if(JSON.stringify(S)===u)return"same"}const f=Z(),T=$(t);return await chrome.storage.sync.set({backupItems:[...i||[],{key:f,count:T}],[f]:L.compressToBase64(u)}),!0}catch(i){const u=chrome.i18n.getMessage("create_backup_failed",i.message);return console.error(u),u}}async function P(){const{backupItems:t}=await chrome.storage.sync.get("backupItems");return t||[]}async function Y(t){const{[t]:i}=await chrome.storage.sync.get(t);if(i&&typeof i=="string"){const u=L.decompressFromBase64(i)||i;return JSON.parse(u)}return i}async function K(t){await chrome.storage.sync.remove(t);const{backupItems:i}=await chrome.storage.sync.get("backupItems"),u=(i||[]).filter(f=>f.key!==t);return await chrome.storage.sync.set({backupItems:u}),!0}async function Q(){const t=await chrome.storage.sync.getBytesInUse(null);if(console.log(`当前已使用存储：${t} 字节`),t<z)return;console.warn("存储空间接近上限，执行清理...");const i=await P();if(i.length>0){const u=Math.floor(i.length/2);for(let f=0;f<u;f++){const{key:T}=i[f];try{await K(T),console.log(`删除备份：${T}`)}catch(g){console.error(`删除备份失败：${T}`,g)}}}}const X=D(()=>{chrome.storage.onChanged.addListener((t,i)=>{if(i==="local"){if(t.enabled){b(t.enabled.newValue),t.enabled.newValue?chrome.storage.local.get(["groups"]).then(({groups:u})=>{M(u)}):M([]);return}t.groups&&M(t.groups.newValue),O()}}),chrome.runtime.onInstalled.addListener(t=>{t.reason==="install"?(chrome.storage.local.set({enabled:!1,groups:[]}),b(!1)):t.reason==="update"&&q()}),q(),chrome.runtime.onMessage.addListener((t,i,u)=>(t.action==="doBackup"&&(O(!0),u("Backup start")),!0))});function ee(){}((U=(I=globalThis.browser)==null?void 0:I.runtime)==null?void 0:U.id)==null?globalThis.chrome:globalThis.browser;function B(t,...i){}const W={debug:(...t)=>B(console.debug,...t),log:(...t)=>B(console.log,...t),warn:(...t)=>B(console.warn,...t),error:(...t)=>B(console.error,...t)};let _;try{_=X.main(),_ instanceof Promise&&console.warn("The background's main() function return a promise, but it must be synchronous")}catch(t){throw W.error("The background crashed on startup!"),t}return _}();
background;
